
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Waypoint Admin Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
    #map { height: 40vh; }
    #editor { flex: 1; overflow-y: auto; padding: 10px; }
    .waypoint { border: 1px solid #ccc; margin-bottom: 10px; padding: 10px; border-radius: 6px; }
    input[type=text], textarea { width: 100%; box-sizing: border-box; margin-bottom: 5px; }
    button { margin-top: 10px; }
  </style>
</head>
<body>

<div id="map"></div>
<div id="editor">
  <h2>Waypoints</h2>
  <div id="waypoints-list"></div>
  <button onclick="downloadGeoJSON()">Download Edited GeoJSON</button>
</div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiYWV2ZWxhbmQiLCJhIjoiY2o4b3IzeGF5MDcyZzMzcnNqcTR5bXd4OCJ9.5FnPH3C-4gGgjSLaluFA8Q';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-115.0, 33.0],
    zoom: 10
  });

  let waypointData = [];

  map.on('load', () => {
    map.addSource('waypoints', {
      type: 'vector',
      url: 'mapbox://aeveland.9f86lh98'
    });

    map.addLayer({
      id: 'waypoint-layer',
      type: 'circle',
      source: 'waypoints',
      'source-layer': 'waypoints',
      paint: {
        'circle-radius': 5,
        'circle-color': '#FF0000'
      }
    });

    // Query all rendered features in the viewport for editing
    const tilesetURL = 'https://api.mapbox.com/v4/aeveland.9f86lh98/features.json?access_token=' + mapboxgl.accessToken;
    fetch(tilesetURL)
      .then(response => response.json())
      .then(data => {
        waypointData = data.features.map((f, i) => ({ ...f, id: i }));
        renderEditor();
      })
      .catch(err => {
        document.getElementById('waypoints-list').innerHTML = '<p style="color:red;">Failed to load features. Mapbox Tilesets API does not support reading this way.</p>';
      });
  });

  function renderEditor() {
    const container = document.getElementById('waypoints-list');
    container.innerHTML = '';

    waypointData.forEach((feature, index) => {
      const div = document.createElement('div');
      div.className = 'waypoint';

      const name = feature.properties.name || '';
      const desc = feature.properties.desc || '';

      div.innerHTML = \`
        <label>Name:</label>
        <input type="text" value="\${name}" onchange="updateField(\${index}, 'name', this.value)" />
        <label>Description:</label>
        <textarea rows="3" onchange="updateField(\${index}, 'desc', this.value)">\${desc}</textarea>
      \`;

      container.appendChild(div);
    });
  }

  function updateField(index, field, value) {
    waypointData[index].properties[field] = value;
  }

  function downloadGeoJSON() {
    const blob = new Blob([JSON.stringify({ type: 'FeatureCollection', features: waypointData }, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'waypoints-edited.geojson';
    link.click();
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
